<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="format-detection" content="telephone=no, address=no, email=no">
<title>MyKia :: Manual</title>
<link rel="stylesheet" type="text/css" href="../css/morpheus_style.css">
<script type="text/javascript" src="../js/mcore.min.js"></script>
</head>
<body id="mk_b02_0001">
<!-- ========== Start ========== -->

    <!-- LayerPop -->
    <div class="lightbox" style="display:none;"></div>
    <div class="popup" style="display:none;">
        <div class="popup_m">
            <div class="popup_in">
                <div class="p_header">
                    <strong><!-- Download --><script type="text/javascript">M.locale.localizedWrite("L1_3")</script></strong>
                </div>
                <div class="p_body loading_space loading">
                    <strong><!-- The manual is downloading --><script type="text/javascript">M.locale.localizedWrite("D1_8")</script></strong>
                    <div class="progressbar">
                        <div class="bar" style="width:0%;" id="per_bar"><div class="bar_in"></div></div>
                    </div>
                    <p><span id="per_int">0</span>/100</p>
                </div>
                <div class="p_footer">
                    <button><!-- CANCEL --><script type="text/javascript">M.locale.localizedWrite("D1_9")</script></button>
                </div>
            </div>
        </div>
    </div>
    <!-- //LayerPop -->


<div id="wrapper">
    <header id="header">
        <div id="normHead">
            <h1><!-- Manual --><script type="text/javascript">M.locale.localizedWrite("D1_5")</script></h1>
            <button type="button" class="hbtn fl home">Home</button>
            <button type="button" class="hbtn fr search" id="srchOpen">Search</button>
        </div>
        
        <div id="srchHead" class="none">
            <h1>Search</h1>
            <p class="search_box">
                <input type="text" placeholder="Car Model" id="srchVal"/>
                <button type="button" class="btn_cancel none">delete</button>
            </p>
            <button type="button" class="hbtn fr" id="srchClose"><!-- Close --><script type="text/javascript">M.locale.localizedWrite("B1_1")</script></button>
        </div>
    </header>
    
    <div class="sub_tab tab_fixed">
        <ul class="hbox jc"> <!-- li tag selected add class='on' -->
            <li class="flex on" data-id="owners">
                <button type="button"><!-- Owner's Manual -->
                    <script type="text/javascript">M.locale.localizedWrite("D1_6")</script>
                </button>
            </li>
            <li class="flex " data-id="quick">
                <button type="button"><!-- Quick Reference Guide -->
                    <script type="text/javascript">M.locale.localizedWrite("D1_7")</script>
                </button>
            </li>
        </ul>
    </div>

    <section id="container">
        <div id="scroll" class="tab_space">
        <!-- contents_Start -->
            
            <!-- list_area -->
            <ul class="li_manual" id="list">
            </ul>
            
            <!-- No Search Result -->
            <div class="result_none none">
                <p><script type="text/javascript">M.locale.localizedWrite("D1_16")</script></p>
            </div>
            
        <!-- //contents_End -->    
        </div>
    </section>

	<footer id="footer">
		<p class="img">KIA, The Power to Surprise.</p>
	</footer>
</div>

<!-- ========== //End ========== -->
</body>
<script type="text/javascript" src="../js/owners.map.js"></script>
<script type="text/javascript" src="../js/ui/common.js"></script>
<script type="text/javascript">
var header={
	"Content-type":"application/x-www-form-urlencoded;charset=utf-8",
	"User-Agent":"Android"
},
gvlSendType = "O",
gvlOwnersList = null,
gvlQuickList = null,
gvlDownloadList = MApi.storage(Storage.OwnersDownloaded),
gvlTheUrl = "",
gvlIsCancel = null;
$("#srchVal").attr("placeholder",M.locale.localizedString("D1_13"));
M.onReady(function(e){
	gvlDownloadList = gvlDownloadList == "" ? [] : gvlDownloadList;
	$("[data-id]").click(function() {
		var target = $(this);
		
		$("[data-id]").removeClass("on");
		
		target.addClass("on");
		var theList = null;
		if ($("[data-id]").index(target) == 0) {
			gvlSendType = "O";
			theList = gvlOwnersList;
		}
		else {
			gvlSendType = "Q";
			theList = gvlQuickList;
		}
		
		if (theList == null) {
			var rtn=gfnGetOwnersParamWithValidate();
			if(rtn==false){
				MApi.alert(M.locale.localizedString("D1_16"));
			}else{
				send(rtn);
			}
		}
		else {
			gfnSendSuccess(theList, {});
		}
	});
	$("[data-id]").eq(0).click();
	
	$("#srchOpen").click(function() {
		$("#normHead").addClass("none");
		$("#srchHead").removeClass("none");
		$("body").addClass("search");
		$("header").addClass("f_popup search");
		$("#container").addClass("f_size");
		$(".sub_tab").addClass("none");
		$("#list > li").addClass("none");
	});
	
	$("#srchClose").click(function() {
		$("header").removeClass("f_popup search");
		$("body").removeClass("search");
		$("#srchHead").addClass("none");
		$("#normHead").removeClass("none");
		$("#container").removeClass("f_size");
		$(".sub_tab").removeClass("none");
		$("#list > li").removeClass("none");
		$("#srchVal").val("");
		$(".btn_cancel").addClass("none");
		$(".result_none").addClass("none");
	});
	
	$("#srchVal").on("input", function() {
		var srchVal = $(this).val(),
			list = $("#list > li");
		if (srchVal != "") {
			$(".btn_cancel").removeClass("none");
		}
		else {
			$(".btn_cancel").addClass("none");
		}
		
		list.each(function(idx, item) {
			if (!list.eq(idx).find("[data-carname]").text().toUpperCase().match(srchVal.toUpperCase())) {
				list.eq(idx).addClass("none");
			}
			else {
				list.eq(idx).removeClass("none");
			}
			
			if (list.not(".none").length == 0) {
				$(".result_none").removeClass("none");
			}
			else {
				$(".result_none").addClass("none");
			}
		});
	});
	
	$(".btn_cancel").on("touchend", function(e) {
		e.preventDefault();
		$("#srchVal").val("");
		$("#list > li").removeClass("none");
		$(".result_none").addClass("none");
		$(this).addClass("none");
	});
	
	$(".p_footer").click(function() {
		gvlIsCancel = "CANCEL";
		M.net.http.cancel(gvlTheUrl);
		$(".lightbox").hide();
		$(".popup").hide();
		gvlIsCancel = null;
	});
});
function gfnGetOwnersParamWithValidate(type, elem){
    var vehicles=LoginManager.getVehiclesInfo().Vehicles;
    var marketId=LoginManager.getDetailsInfo().MarketId;
    var language=M.locale.get().split("-")[0];
    var data="regionId=27&";
    var count=0;
    var country_struct=OWNERS_HASHMAP[marketId];
    if(country_struct==undefined) return false;
    data+="countryId="+country_struct.id+"&";
    var languageId=country_struct.language[language];
    if(languageId==undefined) return false;
    data+="languageId="+languageId+"&";
    if (type && type=="download") {
    	for(var key in country_struct.car){
    		if(key.match(elem.find("[data-carname]").text().toUpperCase())){
    			var car_struct=country_struct.car[key];
                if (car_struct) {
       	            data+="carId="+car_struct.id+"&";
       	            break;
                }
    		}
    	}
    	data+="manualId="+elem.data("manualid")+"&";
    	data+="type="+gvlSendType;
    }
    else {
	    $(vehicles).each(function(i,item){
	    	for(var key in country_struct.car){
	    		if(key.match(item.VehicleName.toUpperCase())){
	    			var car_struct=country_struct.car[key];
	                if (car_struct) {
	                var mdyId=car_struct.mdy["2015"/* item.ModelYear+"" */];
	        	        if(mdyId){
	        	            data+="carId="+car_struct.id+"&";
	        	            data+="modelMy="+mdyId+"&";
	        	            count++;
	        	        }
	                }	
	    		}
	    	}
	    });
	    if(count==0) return false;
	    data+="manualScn="+gvlSendType;
    }
    return data;
}
function send(_data){
	var _trCode="manualList.do";
		var _callback = {
			success:function(rev,setting){
				if (rev.result.length == 0) {
					MApi.alert(M.locale.localizedString("D1_16"));
					return
				}
				gfnSendSuccess(rev, setting);
			}
		};
		
	var nm = new NetworkManager("HTTP_OWNERS",_trCode,_callback);
	
	MApi.log(_data)
	nm.send({
		owners : _data
	});
}

function gfnSendSuccess(rev,setting){
	if (gvlSendType == "O") {
		if (gvlOwnersList == null) {
			gvlOwnersList = rev;
		}
	}
	else if (gvlSendType == "Q") {
		if (gvlQuickList == null) {
			gvlQuickList = rev;
		}
	}
	$("#list").find("li").remove();
	$(rev.result).each(function(idx,item){
		var temp = $("<li class=\"download\"><button><p data-carname=ttt>"+item.carname+"</p><p>"+item.language+"</p></button></li>")
		.data("manualid",item.manualid);
		var file = gfnGetOwnersParamWithValidate("download", temp);
		if (gvlSendType == "Q") {
			temp.addClass("pdf");
		}
		else {
			temp.addClass("zip");
		}
		$(gvlDownloadList).each(function(idx, item2) {
			if (item2.file == file) {
				temp.data("filepath", item2.path);
				temp.removeClass("download");
				return;
			}
		});
		temp.click(function(){
			if (!temp.hasClass("download")) {
				var fullpath = temp.data("filepath");
				if(fullpath.indexOf(".pdf")>-1){
					M.plugin("viewer.doc").open(fullpath);
				}else if(fullpath.indexOf(".zip")>-1){
					var manualpath = "/manual/"+fullpath.substring(fullpath.lastIndexOf("/")+1, fullpath.lastIndexOf(".zip")),
						fileInfo = M.file.info({
							type : "FILE",
							path : "doc://" + manualpath+"/index.html"
						});
					if (fileInfo.status == 'SUCCESS') {
						gfnOpenManual(fullpath);
					} else {
						M.zip.unzip({
							path : fullpath,
							destination : manualpath,
							finish : unZipFunc,
							overwrite : true,
							indicator : false
						});
					}
				}
				return;
			}
			var noticeStr="";
			if (gvlSendType == "Q") {
				noticeStr = M.locale.localizedString("D1_14");
			}
			else {
				noticeStr = M.locale.localizedString("M1_1");
			}
			MApi.confirm(noticeStr, [M.locale.localizedString("N1_6"), M.locale.localizedString("N1_7")], function(idx, result) {
				if (idx == 0) {
					return;
				}
				$("#per_int").text(0);
				$("#per_bar").width("0%");
				$(".lightbox").show();
				$(".popup").show();
				gvlTheUrl = "https://usermanual.kia.com/mobile/manualDownload.do?" + file;
				M.net.http.download({
					url : gvlTheUrl,
					overwrite : true,
					timeout : 20000,
					indicator : false,
					async : false,
					finish : function(status, header, fileinfo, setting) {
						MApi.log(fileinfo);
						if(status==-1){
							$(".lightbox").hide();
							$(".popup").hide();
							if (gvlIsCancel == "CANCEL") {
								gvlIsCancel = null;
							}
							else {
								MApi.alert(M.locale.localizedString("D1_15"));
							}
							return;
						}
						
						var fullpath=fileinfo.fullpath;
						
						M.file.copy({
							type:"FILE",
							source:fileinfo.path,
							destination:fileinfo.path+"TEMP",
							overwrite:true,
							indicator:false
						},function(status,result,setting){
							if(status=="SUCCESS"){
								var rtn=WN2Common("exOwnersFileDescrypt",fullpath+"TEMP",fullpath);
								if(rtn=="SUCCESS"){
									gvlDownloadList.push({file : file, path : fullpath});
									MApi.storage(Storage.OwnersDownloaded, gvlDownloadList);
									temp.data("filepath", fullpath);
									temp.removeClass("download");
// 									MApi.toast(M.locale.localizedString("D1_10"));
									$(".lightbox").hide();
									$(".popup").hide();
									MApi.alert(M.locale.localizedString("D1_10"), function() {downloadFinish(fullpath); });
									function downloadFinish(fullpath) {
										if(fullpath.indexOf(".pdf")>-1){
											M.plugin("viewer.doc").open(fullpath);
										}else if(fullpath.indexOf(".zip")>-1){
											M.zip.unzip({
												path : fullpath,
												destination : "/manual/"+fullpath.substring(fullpath.lastIndexOf("/")+1, fullpath.lastIndexOf(".zip")),
												finish : unZipFunc,
												overwrite : true,
												indicator : false
											});
										}
									}
								}else{
									$(".lightbox").hide();
									$(".popup").hide();
									MApi.alert(M.locale.localizedString("D1_15"));
								}
							}else{
								$(".lightbox").hide();
								$(".popup").hide();
								MApi.alert(M.locale.localizedString("D1_15"));
							}
							M.file.remove({type : 'FILE',path : fileinfo.path+"TEMP"});
						});
					},
					progress : function(total, current, setting) {
						// TODO : web download progress event code here.
						var percent=parseInt((current/total*100));
						$("#per_int").text(percent);
						$("#per_bar").width(percent+"%");
					},
					method:"POST",
// 					body:file,
					encoding:"utf-8",
					header:header
				});
			});
		});
		temp.appendTo($("#list"));
	});
}

function unZipFunc(status, result, option) {
	if (status == "SUCCESS") {
		gfnOpenManual(result.fullpath);
	}
}

function gfnOpenManual(fullpath) {
	fullpath = fullpath.replace("download", "manual").replace(".zip", "");
	
	if (MApi.getPlatform() == "iOS") {
		fullpath = fullpath.substring(fullpath.indexOf("/manual"));
	}
	
	var iframeSrc = fullpath + "/index.html";
	
	var options=Options.Default;
		options.param={
			index:iframeSrc
		};
	Page.moveToPage("manual",options);
}
</script>
</html>