<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="format-detection" content="telephone=no, address=no, email=no">
<title>MyKia :: loading</title>
<link rel="stylesheet" type="text/css" href="../css/morpheus_style.css">
<script type="text/javascript" src="../js/mcore.min.js"></script>
<style>
.spinner-wrap {display:none !important;}
</style>
</head>
<body id="loading">
	<!-- ========== Start ========== -->
	<div class="layer_shadow"></div>
		
	<!-- LayerPop -->
	<div class="popup loading">
		<div class="popup_m">
			<div class="popup_in">
				<strong class="none"><script type="text/javascript">M.locale.localizedWrite("B1_14")</script></strong>
				<div class="progressbar">
					<div class="bar" style="width:0%;" id="per_bar"><div class="bar_in"></div></div>
				</div>
				<p class="none"><span id="per_int">0</span>/100</p>
			</div>
		</div>
	</div>
	<!-- //LayerPop -->

	<div id="wrapper">
		<section id="container">
			<div id="scroll" class="loading_img">
			</div>
		</section>

		<footer id="footer">
			<p class="img">KIA, The Power to Surprise.</p>
		</footer>
	</div>

<!-- ========== //End ========== -->
</body>
<script type="text/javascript" src="../js/ui/common.js"></script>
<script type="text/javascript">
/**
 * resource download :
 * function call sequences
 * 리소스 다운로드 
 * 함수 호출 순서 
 * onReady
 * 1) gvlUserInformation 					- gvlUserInformationCallback 			- 2.4 Get user Information
 * 2) gvlVehiclesNetwork 					- gvlVehiclesInformationCallback 		- 2.6 Get user’s vehicle information (All)
 * 3) gvlVehiclesImageNetwork 				- gvlVechiclesImagesCallback 			- 2.5 Get user’s vehicle images
 * 4) gvlVehiclesImageV2Network 			- gvlVechiclesImagesV2Callback 			- 2.5 Get user’s vehicle images V2
 * 5) gvlDealerInformationNetwork 			- gvlDealerInformationCallback 			- 2.15 Get dealer information
 * 6) gvlSecondDealerInformationNetwork 	- gvlSecondDealerInformationCallback 	- 2.15 Get dealer information
 * 7) gvlMarketInformationNetwork 			- gvlMarketInformationCallback 			- 2.23 Get market specific info
 * 8) gvlRecallInformationNetwork 			- gvlRecallInformationCallback 			- 2.24 Get recall information
 * 9) gvlTranslationVersionNetwork 			- gvlTranslationVersionCallback 		- 2.30 Get Content Version Number 
 *   gvlLegalNoticeNetwork 					- gvlLegalNoticeCallback 				- 2.31 Get Legal Notice
 * 10) gvlTranslationListNetwork 			- gvlTranslationListCallback 			- 2.28 Get translations
 * 11) gvlLegalNoticeNetwork 				- gvlLegalNoticeCallback 				- 2.31 Get Legal Notice
 */

// callback for logout
// 로그아웃 로직
var gvlLogoutCallback={
		success:function(rev,setting){
			LoginManager.clear();
			M.page.html("mk_a00_0002.html",Options.ClearTop);
		},
		error:function(code,msg){
			LoginManager.clear();
			M.page.html("mk_a00_0002.html",Options.ClearTop);
		}
	},
	gvlLogoutNetwork=new NetworkManager(TrCode.Logout,gvlLogoutCallback,false);

// when network error is logged out
// 통신 오류시 로그아웃 시킴
function gvlCommonErrorCallback(code,msg){
	gvlLogoutNetwork.send({
    	"CustomerId" : LoginManager.getCustomerId()
    });
}
var gvlLoginInfo={},
	gvlDetailsInfo={},
	gvlVehiclesInfo={},
	gvlVehiclesImagesV2={},
	gvlVehiclesImages={},
	gvlDealerInfo={},
	gvlSecondDealerInfo={},
	gvlBreakDownCall={},
	gvlRecallInformation={},
	gvlVersionVal=[],
	gvlCnt=0,
	gvlMaxSteps=11,
	gvlSteps=1,
	gvlvarCultureCode=M.locale.get(),
	gvlSelCultureCodeVer=0,
	gvlInterval,
	gvlLoginCallback={
		success:function(rev,setting){
			LoginManager.setLoginInfo(rev);
			MApi.storage(Storage.Authorization,rev.TokenResponse.access_token);
			gvlUserInformation.send({
			    "CustomerId" : gvlLoginInfo.CustomerId
			});
			gvlSteps++;
		},error:gvlCommonErrorCallback
		,networkConnectFail:gvlCommonErrorCallback
	},
	gvlUserInformationCallback={

		// 1) gvlUserInformation - gvlUserInformationCallback - 2.4 Get user Information
	    success:function(rev,setting){
	    	gvlDetailsInfo=rev;
	        gvlVehiclesNetwork.send({
	            "CustomerId" : gvlLoginInfo.CustomerId
	        });
	        gvlSteps++;
	    },error:gvlCommonErrorCallback
	    ,networkConnectFail:gvlCommonErrorCallback
	},
	gvlVehiclesInformationCallback={

		// 2) gvlVehiclesNetwork - gvlVehiclesInformationCallback - 2.6 Get user’s vehicle information (All)
	    success:function(rev,setting){
	        gvlVehiclesInfo=rev;
	        gvlVehiclesImageNetwork.send({
	        	"CustomerId" : gvlLoginInfo.CustomerId
	        });
	        gvlSteps++;
	    },error:gvlCommonErrorCallback
	    ,networkConnectFail:gvlCommonErrorCallback
	},
	gvlVechiclesImagesCallback={

		// 3) gvlVehiclesImageNetwork - gvlVechiclesImagesCallback - 2.5 Get user’s vehicle images
		success:function(rev,setting){
			gvlVehiclesImages=rev;
	        gvlVehiclesImageV2Network.send({
	        	"CustomerId" : gvlLoginInfo.CustomerId
	        });
			gvlSteps++;
		},error:gvlCommonErrorCallback
		,networkConnectFail:gvlCommonErrorCallback
	},
	gvlVechiclesImagesV2Callback={

		// 4) gvlVehiclesImageV2Network - gvlVechiclesImagesV2Callback - 2.5 Get user’s vehicle images V2
		success:function(rev,setting){
			gvlVehiclesImagesV2=rev;
			var dealerSapCode=exRHMDecrypt(gvlDetailsInfo.PreferredDealer);
			if(dealerSapCode==""||dealerSapCode==null){
				gvlDealerInformationCallback.success({},{});
			}else{
				gvlDealerInformationNetwork.send({
					"CustomerId" : gvlLoginInfo.CustomerId,
					"DealerSapCode" : dealerSapCode
				});
			}
			gvlSteps++;
		},error:gvlCommonErrorCallback
		,networkConnectFail:gvlCommonErrorCallback
	},
	gvlDealerInformationCallback={

		// 5) gvlDealerInformationNetwork - gvlDealerInformationCallback - 2.15 Get dealer information
		success:function(rev,setting){
			var cultureCode = LoginManager.getLoginInfo().CultureCode;
			var secondDealerSapCode = exRHMDecrypt(gvlDetailsInfo.SecondDealer);

			if (!M.locale.PocMode && cultureCode == 'en-US') {
				cultureCode = 'en-IE'
			}
			gvlDealerInfo=rev;
			if(secondDealerSapCode==""||secondDealerSapCode==null){
				gvlSecondDealerInformationCallback.success({},{})
			}else{
				gvlMaxSteps = 12;
				gvlSecondDealerInformationNetwork.send({
					"CustomerId" : gvlLoginInfo.CustomerId,
					"DealerSapCode" : secondDealerSapCode
				});
			}
			gvlSteps++;
		},error:function(code,msg){
			gvlMarketInformationNetwork.send({"CultureCode":JsUtil.getMarketIdToCultureCode()});
			gvlSteps++;
		},networkConnectFail:gvlCommonErrorCallback
	},
	gvlSecondDealerInformationCallback={

		// 6) gvlSecondDealerInformationNetwork - gvlSecondDealerInformationCallback - 2.15 Get dealer information
		success:function(rev,setting){
			var cultureCode = LoginManager.getLoginInfo().CultureCode;

			if (!M.locale.PocMode && cultureCode == 'en-US') {
				cultureCode = 'en-IE'
			}
			gvlSecondDealerInfo=rev;
			gvlMarketInformationNetwork.send({"CultureCode":cultureCode});
			gvlSteps++;
		},error:function(code,msg){
			gvlMarketInformationNetwork.send({"CultureCode":JsUtil.getMarketIdToCultureCode()});
			gvlSteps++;
		},networkConnectFail:gvlCommonErrorCallback
	},
	gvlMarketInformationCallback={

		// 7) gvlMarketInformationNetwork - gvlMarketInformationCallback - 2.23 Get market specific info
		success:function(rev,setting){
			JsUtil.deleteFormKey(rev,"Translations");
			gvlBreakDownCall=rev;
			gvlRecallInformationNetwork.send({"CustomerId" : gvlLoginInfo.CustomerId});
			gvlSteps++;
		},error:gvlCommonErrorCallback
		,networkConnectFail:gvlCommonErrorCallback
	},
	gvlRecallInformationCallback={

		// 8) gvlRecallInformationNetwork - gvlRecallInformationCallback - 2.24 Get recall information
		success:function(rev,setting){
			JsUtil.deleteFormKey(rev,"ResponseCode");
			JsUtil.deleteFormKey(rev,"ResponseMessage");
			gvlRecallInformation=rev;
			gvlTranslationVersionNetwork.send({empty:"empty"});
			gvlSteps++;
		},error:gvlCommonErrorCallback
		,networkConnectFail:gvlCommonErrorCallback
	},
	gvlTranslationVersionCallback={

		// 9) gvlTranslationVersionNetwork - gvlTranslationVersionCallback - 2.30 Get Content Version Number 
		success:function(rev,setting){
			JsUtil.deleteFormKey(rev,"ResponseCode");
			JsUtil.deleteFormKey(rev,"ResponseMessage");
			gvlVersionVal = rev.TranslationVersions;
			var versionCheck = false;
			var culturecode=M.locale.get();
			var userCulturecode=LoginManager.getLoginInfo().CultureCode;

			if (!M.locale.PocMode && culturecode == 'en-US') {
				culturecode = 'en-IE'
			}
			$(gvlVersionVal).each(function(i, item) {
				if (culturecode == item.CultureCode.toLowerCase()) {
					var culturecodeversion = MApi.storage(culturecode+"-ver");
					if (culturecodeversion == item.Version) {
						versionCheck = true;
						return false;
					}
					else {
						gvlSelCultureCodeVer = item.Version;
						return false;
					}
				}
			});

			gvlvarCultureCode=culturecode;
			// login user's language use
			if(userCulturecode != undefined && culturecode != userCulturecode){
				gvlvarCultureCode=userCulturecode;
				gvlTranslationListNetwork.send({"CultureCode":gvlvarCultureCode});
			}else if(versionCheck){
				gvlSteps++;
				gvlLegalNoticeNetwork.send({
					"CultureCode":culturecode
				});
			}else{
				gvlTranslationListNetwork.send({"CultureCode":gvlvarCultureCode});
			}
			gvlSteps++;
		},error:gvlCommonErrorCallback
		,networkConnectFail:gvlCommonErrorCallback
	},
	gvlTranslationListCallback={

		// 10) gvlTranslationListNetwork - gvlTranslationListCallback - 2.28 Get translations
		success:function(rev,setting){
			JsUtil.deleteFormKey(rev,"ResponseCode");
			JsUtil.deleteFormKey(rev,"ResponseMessage");
			//var culturecode=M.locale.get();
			var culturecode=gvlvarCultureCode;

			if (!M.locale.PocMode && culturecode == 'en-US') {
				culturecode = 'en-IE'
			}
			if(rev.Translations.length!=0) gfnGenerater(rev,culturecode);
			gvlLegalNoticeNetwork.send({
				"CultureCode":LoginManager.getLoginInfo().CultureCode
			});
			gvlSteps++;
		},error:gvlCommonErrorCallback
		,networkConnectFail:gvlCommonErrorCallback
	},
	gvlLegalNoticeCallback = {

		// 11) gvlLegalNoticeNetwork - gvlLegalNoticeCallback - 2.31 Get Legal Notice
		success:function(rev,setting){
			
			// 보류: 업데이트 날짜를 저장한다.
			//var currentTimestamp = new Date().getTime()
			//MApi.storage(Storage.LastUpdate, currentTimestamp);

			MApi.storage(Storage.LegalContent, rev);
			gvlSteps++;
		},error:gvlCommonErrorCallback
		,networkConnectFail:gvlCommonErrorCallback
	},

	// 2.1 Log in (User ID)
	gvlLoginNetwork=new NetworkManager(TrCode.Login,gvlLoginCallback,true,{web:false}),
	
	// 2.2 Log in (Using the Facebook session token)
	gvlFbLoginNetwork=new NetworkManager(TrCode.FbLogin,gvlLoginCallback,true,{web:false}),
	
	// 1) gvlUserInformation - gvlUserInformationCallback - 2.4 Get user Information
	gvlUserInformation=new NetworkManager(TrCode.UserInformation,gvlUserInformationCallback,true,{web:false}),
	
	// 2) gvlVehiclesNetwork - gvlVehiclesInformationCallback - 2.6 Get user’s vehicle information (All)
	gvlVehiclesNetwork=new NetworkManager(TrCode.VehiclesInformation,gvlVehiclesInformationCallback,true,{web:false}),
	
	// 3) gvlVehiclesImageNetwork - gvlVechiclesImagesCallback - 2.5 Get user’s vehicle images
	gvlVehiclesImageNetwork=new NetworkManager(TrCode.VehiclesImages,gvlVechiclesImagesCallback,true,{web:false}),

	// 4) gvlVehiclesImageV2Network - gvlVechiclesImagesV2Callback - 2.5 Get user’s vehicle images V2
	gvlVehiclesImageV2Network=new NetworkManager(TrCode.VehiclesImagesV2,gvlVechiclesImagesV2Callback,true,{web:false}),
	
	// 5) gvlDealerInformationNetwork - gvlDealerInformationCallback - 2.15 Get dealer information
	gvlDealerInformationNetwork=new NetworkManager(TrCode.DealerInformation,gvlDealerInformationCallback,true,{web:false}),
	// 6) gvlSecondDealerInformationNetwork - gvlSecondDealerInformationCallback - 2.15 Get dealer information
	gvlSecondDealerInformationNetwork=new NetworkManager(TrCode.DealerInformation,gvlSecondDealerInformationCallback,true,{web:false}),
	
	// 7) gvlMarketInformationNetwork - gvlMarketInformationCallback - 2.23 Get market specific info
	gvlMarketInformationNetwork=new NetworkManager(TrCode.MarketInformation,gvlMarketInformationCallback,true,{web:false}),
	
	// 8) gvlRecallInformationNetwork - gvlRecallInformationCallback - 2.24 Get recall information
	gvlRecallInformationNetwork=new NetworkManager(TrCode.RecallInformation,gvlRecallInformationCallback,true,{web:false}),
	
	// 9) gvlTranslationVersionNetwork - gvlTranslationVersionCallback - 2.30 Get Content Version Number 
	gvlTranslationVersionNetwork=new NetworkManager(TrCode.ContentVersion,gvlTranslationVersionCallback,true,{web:false}),
	
	// 10) gvlTranslationListNetwork - gvlTranslationListCallback - 2.28 Get translations
	gvlTranslationListNetwork=new NetworkManager(TrCode.TranslationList,gvlTranslationListCallback,true,{web:false}),
	
	// 11) gvlLegalNoticeNetwork - gvlLegalNoticeCallback - 2.31 Get Legal Notice
	gvlLegalNoticeNetwork=new NetworkManager(TrCode.GetLegalNotice,gvlLegalNoticeCallback,true,{web:false});

gvlInterval=setInterval(function(){
	var per=gvlCnt;
	if(per>=100){
		clearInterval(gvlInterval);
		if(gvlMaxSteps<=gvlSteps) movePage();
	}else{
		$("#per_int").text(per);
		$("#per_bar").width(per+"%");
		if(((gvlSteps*100)/(gvlMaxSteps*100)*100)>gvlCnt) gvlCnt+=1;
	}
},50);

// once loading is complete, the screen moves
// 로딩이 완료되면 화면 이동한다.
function movePage(){
	gfnSetAllInformation();
	$("#per_int").text(100);
	$("#per_bar").width("100%");
	LoginManager.setSyncDate(new Date().getDateString("YYYYMMDD"));
	setTimeout(function(){
		var option=Options.Default,
			redirectPage = MApi.param("redirect"),
			hash = MApi.param("hash");

		if (redirectPage == "setting") {
			
			// move to setting screen
			// setting 화면으로 이동한다.
			Page.backPage();
			return;
		}
		// if (LoginManager.getVehiclesInfo().Vehicles.length>1) {
			
		// 	// move to MY VEHICLE all car screen(mk_a00_0004)
		// 	// 사용자 차량 선택 화면(mk_a00_0004)으로 이동한다
		// 	// option.param={
		// 	// 	 redirect:redirectPage
		// 	// 	,hash: hash
		// 	// };

		// 	MApi.storage(Storage.selectedVehicle, 0);

		// 	redirectPage="mk_a00_0005";
		// 	option=Options.ClearTop;

		// 	Page.moveToPage(redirectPage,option);

		// 	// option.action = "NO_HISTORY";
	 //  //   	Page.moveToPage("mk_a00_0004",option);
		// }else{
			// move to redirect page
			// redirect page로 이동한다.
			MApi.storage(Storage.selectedVehicle,0);
			option.hash = hash;
			if(!redirectPage){
				redirectPage="mk_a00_0005";
				option=Options.ClearTop;
			}
		    Page.moveToPage(redirectPage, option);
		// }
	},1000);
}

// save all loaded data
// 모든 데이터를 저장한다.
function gfnSetAllInformation(){
	try{
		LoginManager.setLoginInfo(gvlLoginInfo);
		LoginManager.setDetailsInfo(gvlDetailsInfo);
		LoginManager.setVehiclesInfo(gvlVehiclesInfo);
		var vehicles=LoginManager.getVehiclesInfo();
		for(var i=0;i<vehicles.Vehicles.length;i++){
			vehicles.Vehicles[i].VIN=exRHMDecrypt(vehicles.Vehicles[i].VIN);
		}
		for(var i=0;i<gvlVehiclesImages.Vehicles.length;i++){
			for(var j=0;j<vehicles.Vehicles.length;j++){
				if(vehicles.Vehicles[j].VIN==gvlVehiclesImages.Vehicles[i].VIN){
					vehicles.Vehicles[j].VehicleImageExtension=gvlVehiclesImages.Vehicles[i].VehicleImageExtension;
					vehicles.Vehicles[j].VehicleImage=gvlVehiclesImages.Vehicles[i].VehicleImage;
					vehicles.Vehicles[j].VehicleImageUrl=gvlVehiclesImagesV2.Vehicles[i].VehicleImageUrl;
				}
			}
		}
		LoginManager.setVehiclesInfo(vehicles);
		LoginManager.setDealerInfo(gvlDealerInfo);
		LoginManager.setSecondDealerInfo(gvlSecondDealerInfo);
		LoginManager.setBreakDownCall(gvlBreakDownCall);
		LoginManager.setRecallInformation(gvlRecallInformation);

		// KMD 구분을 위한 marketId 저장
		MApi.storage(Storage.MarketId,gvlDetailsInfo.MarketId);
	}catch(e){
		MApi.alert(M.locale.localizedString("S1_5"),gvlCommonErrorCallback);
	}
}

// save translation code
// 번역코드를 저장한다.
function gfnGenerater(data,culturecode){
	var gen={};
	[].forEach.call(data.Translations,function(item){
		for(var i in item){
			gen[i]=item[i];
		}
	});
	MApi.storage(culturecode,gen);
	MApi.storage(culturecode+"-ver", gvlSelCultureCodeVer);
	M.locale.set(culturecode);
}
M.onReady(function(e){
	updateResource();
	return false;

	/** hold: the data are download at login
	 *  보류: 로그인시 데이터를 다운로드 받는다
	var lastUpdateVal = MApi.storage(Storage.LastUpdate);
		,timestamp = new Date().getTime()

	// if the last download history, download the data
	// 마지막 다운로드 이력이 없으면 데이터를 다운로드 한다.
	if (!lastUpdateVal) {
		updateResource();
		return false;
	}

	// if the 60 days prior to the update history, download the data
	// 60일 이전에 업데이트 이력이 있으면 데이터를 다운로드 한다.
	if ( diffDay(timestamp) >= 60 ) {
		updateResource();
		return false;
	}

	// if the 60 days prior to the last update does not download it
	// 최종 업데이트가 60일 이전이면 다운로드 하지 않는다.
	movePage();
	*/
});

M.onHide(function(e){
	setTimeout(function(){
		$("html").hide();
	},2000);
});

/*
 * resource update
 */
function updateResource() {
	MApi.remove("www/html/mk_a00_0010.html");
	MApi.remove("www/html/mk_a00_0002.html");
	gvlLoginInfo=LoginManager.getLoginInfo();
    gvlUserInformation.send({
	    "CustomerId" : gvlLoginInfo.CustomerId
	});
}

/* 
 * calculate data difference
 * 날짜 차이 계산
 * @param date timestamp (ex. 1457429537796)
 */
function diffDay(date) {
	if (!date) {
		return false;
	}
	var  currentDate = new Date().getTime()
		,diffDate = new Date(date).getTime()
		,difference = currentDate - diffDate
		,daysDifference = Math.floor(difference/1000/60/60/24);
	return daysDifference;
}


M.onBack=function(){};
</script>
</html>

