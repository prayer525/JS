<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="format-detection" content="telephone=no, address=no, email=no">
<title>MyKia :: Manual</title>
<link rel="stylesheet" type="text/css" href="../css/morpheus_style.css">
<script type="text/javascript" src="../js/mcore.min.js"></script>
</head>
<body id="mk_b02_0001">
<!-- ========== Start ========== -->

    <!-- LayerPop -->
    <div class="lightbox none"></div>
    <div class="popup none" id="downloadPopup">
        <div class="popup_m">
            <div class="popup_in">
                <div class="p_header">
                    <strong class="download-popup-title"><!-- Download --><script type="text/javascript">M.locale.localizedWrite("L1_3")</script></strong>
                </div>
                <div class="p_body loading_space loading">
                    <strong class="download-popup-message"><!-- The manual is downloading --><script type="text/javascript">M.locale.localizedWrite("D1_8")</script></strong>
                    <div class="progressbar">
                        <div class="bar" style="width:0%;" id="per_bar"><div class="bar_in"></div></div>
                    </div>
                    <p><span id="per_int">0</span>/100</p>
                </div>
                <div class="p_footer">
                    <button type="button" id="btn_download_cancel"><!-- CANCEL --><script type="text/javascript">M.locale.localizedWrite("D1_9")</script></button>
                </div>
            </div>
        </div>
    </div>
    <!-- //LayerPop -->
	<!-- LayerPop -->
    <div class="popup" id="morePopup" style="display: none;">
        <div class="popup_m" style="vertical-align: bottom;" id="morePopupBox">
            <div class="popup_in">
                <div class="more_popup">
                    <button class="open_btn" id="openIn"><script type="text/javascript">M.locale.localizedWrite("L1_5")</script></button>
                    <button class="download_btn" id="download"><script type="text/javascript">M.locale.localizedWrite("L1_4")</script></button>
                </div>
            </div>
        </div>
    </div>
    <!-- //LayerPop -->
<div id="wrapper">
    <header id="header">
        <div id="normHead">
            <h1><!-- Manual --><script type="text/javascript">M.locale.localizedWrite("D1_5")</script></h1>
            <button type="button" class="hbtn fl home">Home</button>
            <!-- Remove search icon on top manuals page 2017.02.24 -->
            <!-- <button type="button" class="hbtn fr search" id="srchOpen">Search</button> -->
        </div>
        
        <div id="srchHead" class="none">
            <h1>Search</h1>
            <p class="search_box">
                <input type="text" placeholder="Car Model" id="srchVal"/>
                <button type="button" class="btn_cancel none">delete</button>
            </p>
            <button type="button" class="hbtn fr" id="srchClose"><!-- Close --><script type="text/javascript">M.locale.localizedWrite("B1_1")</script></button>
        </div>
    </header>
    
    <!-- Display a single list for both QRG, owner manuals and navigation manuals 2017.02.24 -->
    <!-- <div class="sub_tab tab_fixed">
        <ul class="hbox jc"> li tag selected add class='on'
            <li class="flex on" data-id="quick">
                <button type="button">Quick Reference Guide
                    <script type="text/javascript">M.locale.localizedWrite("D1_7")</script>
                </button>
            </li>
            <li class="flex" data-id="owners">
                <button type="button">Owner's Manual
                    <script type="text/javascript">M.locale.localizedWrite("D1_6")</script>
                </button>
            </li>
        </ul>
    </div> -->

    <section id="container">
        <div id="scroll">
        <!-- remove tab -->
        <!-- <div id="scroll" class="tab_space"> -->
        <!-- contents_Start -->
            
            <!-- list_area -->
            <ul class="li_manual" id="list">
            </ul>
            
            <!-- No Search Result -->
            <div class="result_none_file none">
                <p><script type="text/javascript">M.locale.localizedWrite("D1_17")</script></p>
            </div>

            
            
        <!-- //contents_End -->    
        </div>
    </section>

	<footer id="footer">
		<p class="img">KIA, The Power to Surprise.</p>
	</footer>
</div>

<!-- ========== //End ========== -->
</body>
<script type="text/javascript" src="../js/owners.map.js"></script>
<script type="text/javascript" src="../js/ui/common.js"></script>
<script type="text/javascript">
var myvehicle=LoginManager.getSelectedVehiclesInfo();
var platform=MApi.getPlatform();
var gvlSendType = 1,
gvlDocumentList = [],
gvlOwnersList = null,
gvlQuickList = null,
gvlTheUrl = "",
gvlIsCancel = null,
gvlTemp = null,
gvlGetDocumentCallback={
	success:gfnSendSuccess,
	error:function(response,responseMsg){
		$("#list").html("");
		$('.result_none_file').removeClass('none');
	}
},
gvlGetDocumentNetwork=new NetworkManager(TrCode.GetDocumentList,gvlGetDocumentCallback,true);
$("#srchVal").attr("placeholder",M.locale.localizedString("D1_13"));

M.onReady(function(e){
	init();

	$('#morePopupBox').click(gfnCloseMorePopup);
	$('#download').click(gfnDownload);
	$('#openIn').click(gfnOpenIn);
});

// Tab 삭제 및 목록 통합으로 인한 추가 내용 2017.02.24
function init(){
	gfnGetDocumentList();
}

function gfnGetDocumentList(){
	gvlGetDocumentNetwork.send({
		CultureCode:M.locale.get(),
		MarketId:LoginManager.getDetailsInfo().MarketId,
		VIN:myvehicle.VIN
	});
}

function gfnSendSuccess(rev,setting){
	gvlDocumentList = gvlDocumentList.concat(rev.Documents);
	
	if(gvlDocumentList.length==0) $('.result_none_file').removeClass('none'); //MApi.alert(M.locale.localizedString("D1_17"));
	$(gvlDocumentList).each(function(idx,item){
		var temp = '';
		var noticeStr="";
		
		/* if (item.DocumentfileName.toLowerCase().indexOf("qrg/") >= 0){
			noticeStr = M.locale.localizedString("D1_14");
		} else {
			noticeStr = M.locale.localizedString("M1_1");
		} */
		
		/* if(platform=="iOS") { */
			temp = $("<li class=\"download\"><button><p data-carname=ttt>"+item.DocumentTitle+"</p><p>"+item.PublishDate+"</p></button></li>")
			.data("DocumentfileName",item.DocumentfileName).data("noticeStr",noticeStr);
		/* }else{
			var internal=$('<img src="../img/li_type_down.png" class="left">');
			var external=$('<img src="../img/li_type_share.png">');
			
			temp = $("<li class=\"download\"><div><p data-carname=ttt>"+item.DocumentTitle+"</p><p>"+item.PublishDate+"</p></div></li>")
			.data("DocumentfileName",item.DocumentfileName);

			internal.click(function(){
				if(temp.hasClass("download")){
					// download content from server by API 2.34 if item doesn't downloaded
					// 해당 리스트 아이템을 다운로드 받지 않은 경우
					// API 2.34. 통신을 하여 서버로 부터 다운로드 받는다.
					gfnDownloadDocument(temp, noticeStr, 'internal', internal);
				}else{
					
					// move to detail screen when you already has been downloaded item
					// 해당 리스트 아이템을 다운로드 받은 경우
					// 상세 내용으로 이동한다.
					gfnShowDocument(temp);
				}
			});

			external.click(function(){
				// download content from server by API 2.34 if item doesn't downloaded
				// 해당 리스트 아이템을 다운로드 받지 않은 경우
				// API 2.34. 통신을 하여 서버로 부터 다운로드 받는다.
				gfnDownloadDocument(temp, noticeStr, 'external');
			});
			
			temp.append(external).append(internal);
		} */
		
		temp.addClass(gfnGetExtension(item.DocumentfileName));

		var validatePath="";
		var myvehicle=LoginManager.getSelectedVehiclesInfo();
		if(gfnGetExtension(item.DocumentfileName)=="pdf"){
			if(M.locale.VirtualMode){
				validatePath = gfnGetSavePath(item.DocumentfileName)+gfnGetFileName(item.DocumentfileName);
			} else {
				validatePath="doc://"+myvehicle.VIN+"/"+gfnGetSavePath(item.DocumentfileName)+gfnGetFileName(item.DocumentfileName);
			}
		}else{
            var folderName=gfnGetFileName(item.DocumentfileName);
            folderName=folderName.substring(0,folderName.lastIndexOf("."));
			validatePath='doc://'+myvehicle.VIN+"/"+gfnGetSavePath(item.DocumentfileName)+folderName;
		}
		var fileInfo = M.file.info({
	        path : validatePath
	    });
	    
	    if(fileInfo.status=="SUCCESS"){
	    	temp.data("filepath", "doc://"+myvehicle.VIN+"/"+gfnGetSavePath(item.DocumentfileName)+gfnGetFileName(item.DocumentfileName));
			temp.removeClass("download");
	    }
	    if (M.locale.VirtualMode) {
    		temp.data("filepath", gfnGetSavePath(item.DocumentfileName)+gfnGetFileName(item.DocumentfileName));
    		temp.removeClass("download");
    	}

	    // when you tap each list
	    // 각 리스트 터치 시
		temp.click(function(){
			gvlTemp = temp;
			$(".lightbox").removeClass('none');
			$("#morePopup").fadeIn();
		});
		temp.appendTo($("#list"));
	});

}
function gfnDownload(){
	$(".download-popup-title").text(M.locale.localizedString("L1_3"))
	$(".download-popup-message").text(M.locale.localizedString("D1_8"))

	gfnDownloadDocument(gvlTemp, false, noticeStr = M.locale.localizedString("M1_1"));
}

function gfnOpenIn(){
	var popTitle = M.locale.localizedString("L1_3"),
		popMessage = M.locale.localizedString("D1_8");

	if(M.locale.localizedString("Y2_23") != "Y2_23"){
		popTitle = M.locale.localizedString("Y2_23")
	}

	if(M.locale.localizedString("Y2_24") != "Y2_24"){
		popMessage = M.locale.localizedString("Y2_24")
	}
	
	$(".download-popup-title").text(popTitle);
	$(".download-popup-message").text(popMessage);
	
	if(gvlTemp.hasClass("download")){
		// download content from server by API 2.34 if item doesn't downloaded
		// 해당 리스트 아이템을 다운로드 받지 않은 경우
		// API 2.34. 통신을 하여 서버로 부터 다운로드 받는다.
		gfnDownloadDocument(gvlTemp, true, noticeStr = M.locale.localizedString("D1_14"));
	}else{
		// move to detail screen when you already has been downloaded item
		// 해당 리스트 아이템을 다운로드 받은 경우
		// 상세 내용으로 이동한다.
		gfnShowDocument(gvlTemp);
	}
}

// move to Document Viewer screen
// Document Viewer 화면으로 이동한다.
function gfnShowDocument(temp){
	var fullpath = $(temp).data("filepath");

	if(fullpath.lastIndexOf(".pdf")>-1||fullpath.lastIndexOf(".PDF")>-1){
		if(platform=="iOS"){
			//M.plugin("viewer.doc").open(fullpath);
			var params={};
			params.path=fullpath;
			params.orientation="DEFAULT";
			params.animation="NONE";
			if(gvlSendType==1) params.title=M.locale.localizedString("D1_6");
			else params.title=M.locale.localizedString("D1_7");
			/*
			M.viewer.open({
			   title:params.title,
			   path:params.path,
			});
			 */

			M.plugin("viewer.doc").open({
				title:params.title,
				path:params.path
			});

		}else{
			// var pathParameter = {
			// 	 fullPath:$(temp).data("filepath")
			// 	,pageTitle:$('.hbox.jc').find('li.on').text()
			// };

			// M.data.storage('pathParam', pathParameter)

			// Page.moveToTargetPage($(temp), temp[0]);

			var params={};
			params.path=fullpath;
			params.orientation="DEFAULT";
			params.animation="NONE";
			if(gvlSendType==1) params.title=M.locale.localizedString("D1_6");
			else params.title=M.locale.localizedString("D1_7");
			WN2Common("exWNMuPDFActivity",JSON.stringify(params));
		}
	}else if(fullpath.lastIndexOf(".zip")>-1||fullpath.lastIndexOf(".ZIP")>-1){
		var manualpath=fullpath.substring(0,fullpath.lastIndexOf(".zip"));
		var fileInfo = M.file.info({
			type : "FILE",
			path : manualpath+"/index.html"
		});
		if (fileInfo.status == 'SUCCESS') {
			gfnOpenManual(fileInfo.path);
		}
	}
}

// return file name
// 파일 이름을 반환한다.
function gfnGetFileName(path){
	var result=path.substring(path.lastIndexOf("/")+1,path.length);
	return result.replace(/ /g,"").toLowerCase();
}

// return file path
// 파일 경로를 반환한다.
function gfnGetSavePath(path){
	return path.substring(0,path.lastIndexOf("/")+1);
}

// download content from server by API 2.34 if item doesn't downloaded
// 해당 리스트 아이템을 다운로드 받지 않은 경우
// API 2.34. 통신을 하여 서버로 부터 다운로드 받는다.
function gfnDownloadDocument(temp, type, noticeStr){
	MApi.confirm(noticeStr, [M.locale.localizedString("N1_6"), M.locale.localizedString("N1_7")], function(idx, result) {
		if (idx == 0) {
			return;
		}
		$("#per_int").text(0);
		$("#per_bar").width("0%");
		//$(".lightbox").show();
		//$(".popup").show();
		$(".lightbox").removeClass('none');
		$("#downloadPopup").removeClass('none');
		var params={};
		params.DocumentFileName=temp.data("DocumentfileName");
		gvlTheUrl=JsUtil.getNetworkUrl()+TrCode.GetDocument;
		gvlTheUrl+="?/"+gfnGetFileName(params.DocumentFileName);  //original
		//gvlTheUrl+="?"+gfnGetFileName(params.DocumentFileName);  //for ios download test case 1
		
		M.net.http.download({
			url:gvlTheUrl,
			overwrite:true,
			timeout:60000,
			indicator:false,
			async:false,
			finish : function(status, header, fileinfo, setting) {
				if(status!=200){

					// remove download temporary files when download canceled or failed
					// 다운로드 취소/실패 시 다운로드 임시 파일을 삭제한다. 
					gfnCloseDownloadPopup();
					if (gvlIsCancel == "CANCEL") {
						gvlIsCancel = null;
					}else {
						MApi.alert(M.locale.localizedString("D1_15"));
					}
				}else{

					// when download complete
					// 다운로드 완료 시
					var fileName=temp.data("DocumentfileName");
					var fullpath=fileinfo.fullpath;
					
					if(type){
						gfnFileMove(temp,fileName,fullpath);
					}else{
						if(platform=="iOS") {
							gfnOpenDocument(temp,fileName,fullpath);
						}else{
							gfnExternalMove(temp,fileName,fullpath);
						}
					}
					
				}
			},
			progress : function(total, current, setting) {
				var percent=parseInt((current/total*100));
				$("#per_int").text(percent);
				$("#per_bar").width(percent+"%");
			},
			method:"POST",
			encoding:"utf-8",
			parameters:params,
			header:{
				"Content-Type":"application/json",
				"Authorization":"Bearer "+MApi.storage(Storage.Authorization)
			}
		});

		$('#btn_download_cancel').click(function(){
			gvlIsCancel = 'CANCEL';
			M.net.http.cancel({
				url:gvlTheUrl
			})
		})
	});
}

function unZipFunc(status, result, option) {
	gfnCloseDownloadPopup();
	if (status == "SUCCESS") {
		MApi.alert(M.locale.localizedString("D1_10"),function(){
            gfnOpenManual(result.path+"/index.html");
		});
		// setTimeout(function(){
		//		var removeResult = M.file.remove({
		//			type : 'FILE',
		//      	path : fullpath,
		// 		});
		// },2000);
	}else{
		MApi.alert(M.locale.localizedString("D1_15"));
	}
}

function gfnOpenManual(fullpath) {
	var options=Options.Default;
		options.param={
			index:fullpath
		};
	Page.moveToPage("manual",options);
}

function gfnGetExtension(fileName){
	fileName=fileName.replace(/ /g,"").toLowerCase();
	if(fileName.lastIndexOf(".pdf")>-1) return "pdf";
	else if(fileName.lastIndexOf(".zip")>-1) return "zip";
}

// save the file path
// 파일을 경로에 저장한다.
function gfnFileMove(temp,fileName, fullpath){
	var myvehicle=LoginManager.getSelectedVehiclesInfo();
	var validatePath="doc://"+myvehicle.VIN+"/"+fileName.substring(0,fileName.lastIndexOf("/")+1);
	var fileInfo = M.file.info({
        path:validatePath
    });
    if(fileInfo.status == 'SUCCESS'){
    	move();
    }else{
    	var rtn=M.file.create({
			type:"DIR",
			path:validatePath
		});
		if(rtn.status=="SUCCESS"){
			move();
		}else{
			MApi.alert(M.locale.localizedString("D1_15"));
		}
    }

    function move(){
    	M.file.move({
			type:"FILE",
			source:fullpath,
			indicator:false,
			destination:"doc://"+myvehicle.VIN+"/"+gfnGetSavePath(fileName)+gfnGetFileName(fileName),
			overwrite:true,
			finish:function(status,error){
				if(status=="SUCCESS"){
		        	temp.data("filepath", "doc://"+myvehicle.VIN+"/"+gfnGetSavePath(fileName)+gfnGetFileName(fileName));
					temp.removeClass("download");

					if(gfnGetExtension(fileName)=="pdf"){
						gfnCloseDownloadPopup();
						gfnComplete(fullpath,temp);
					}else{
						gfnUnZip("doc://"+myvehicle.VIN+"/"+gfnGetSavePath(fileName)+gfnGetFileName(fileName));
					}
				}else{
					gfnCloseDownloadPopup();
					MApi.alert(M.locale.localizedString("D1_15"));
				}
			}
		});
    }
}
function gfnExternalMove(temp, fileName, fullpath){
	var validatePath = WN2Common("exWNgetExternaDirectory")+"/MyKia/";
	var fileInfo = M.file.info({
        path:validatePath
    });
    
    if(fileInfo.status == 'SUCCESS'){
    	move();
    }else{
    	var rtn=M.file.create({
			type:"DIR",
			path:validatePath
		});
		if(rtn.status=="SUCCESS"){
			move();
		}else{
			MApi.alert(M.locale.localizedString("D1_15"));
		}
    }
    function move(){
    	var status = WN2Common("exWNmoveFile",fullpath,validatePath+gfnGetFileName(fileName));
    	if(status == "SUCCESS"){
    		gfnCloseDownloadPopup();
    		MApi.alert(M.locale.localizedString("D1_10")+'\n'+M.locale.localizedString("D1_22"));
    	}else{
    		gfnCloseDownloadPopup();
    		MApi.alert(M.locale.localizedString("D1_15"));
    	}
    }
}

// iOS document menu open
// iOS 문서 메뉴 열기
function gfnOpenDocument(temp, fileName, fullpath){
 	var result = WN2Common("exWNopenDocumentIn", fullpath);
 	if(result == 'YES'){
 		gfnCloseDownloadPopup();
	}else{
 		MApi.alert(M.locale.localizedString("D1_15"));
 	}
}
// unzip file
// zip 파일 경우 압축 해제한다.
function gfnUnZip(fullpath){
	var manualpath=fullpath.substring(0,fullpath.lastIndexOf(".zip"));
	M.zip.unzip({
		path : fullpath,
		destination : manualpath,
		finish : unZipFunc,
		overwrite : true,
		indicator : false
	});
}

function gfnComplete(fullpath,temp){
	gfnShowDocument(temp);
	/*
	MApi.alert(M.locale.localizedString("D1_10"),function(){
		
	});
	*/
	setTimeout(function(){
        var removeResult = M.file.remove({
            type : 'FILE',
            path : fullpath,
        });
	},2000);
}

// close popup when you cancel downloads
// 다운로드 취소 시 팝업을 닫음
function gfnCloseDownloadPopup(){
	//$(".lightbox").hide();
	//$(".popup").hide();
	$(".lightbox").addClass('none');
	$("#downloadPopup").addClass('none');
}

function gfnCloseMorePopup(){
	$("#morePopup").fadeOut();
	$(".lightbox").addClass('none');
}

</script>
</html>