<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="format-detection" content="telephone=no, address=no, email=no">
<title>MyKia :: Search</title>
<link rel="stylesheet" type="text/css" href="../css/morpheus_style.css">
<script type="text/javascript" src="../js/mcore.min.js"></script>
</head>
<body id="mk_c02_0004" class="search">
<!-- ========== Start ========== -->

<div id="wrapper">
	<header id="header" class="f_popup search">
		<h1>Search</h1>
		<p class="search_box">
			<input type="text" placeholder="Zip or City, Dealer name" id="srchVal"/>
			<button type="button" class="btn_cancel none">delete</button>
		</p>
		<button type="button" class="hbtn fr" id="close"><!-- Close --><script type="text/javascript">M.locale.localizedWrite("B1_1")</script></button>
	</header>

    <section id="container">
		<div id="scroll">
        <!-- contents_Start -->
            
            <!-- search_result_List -->
			<ul class="li_style_move" id="list">
				<!-- <li class="map_sub type02">							
					<button type="button">
						<h2 class="ellipsis">BACCI MOTORS SRL</h2>
						<p>STRADA DI BUSSETO, ANG. VIALE TOSELLI, 18 53100 SIENA(SI)</p>
						<p class="txt_pos">2.9 KM</p>
					</button>
				</li> -->
			</ul>
            
			<div class="result_none none"><!-- contents No result view -->
				<p><!-- No Search Result --><script type="text/javascript">M.locale.localizedWrite("D1_16")</script></p>
			</div>
            
        <!-- //contents_End -->
		</div>
	</section>

	<footer id="footer">
		<p class="img">KIA, The Power to Surprise.</p>
	</footer>
</div>

<!-- ========== //End ========== -->
</body>
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false&libraries=places"></script>
<script type="text/javascript" src="../js/ui/common.js"></script>
<script type="text/javascript">
var gvlGetItemList = null
	,gvlCurPosition
	,gvlInitScreenHeight

gvlGetItemCallback={
	success:function(rev,setting){
		MApi.log(rev);

		gvlGetItemList = rev.Dealers;
		
		gfnItemProc();
	}
},
gvlGetItemNetwork=new NetworkManager(TrCode.DealerSearching,gvlGetItemCallback,false),
M.onReady(function(e){
	gvlCurPosition = MApi.param("myPosition")
	gvlInitScreenHeight=0;
	$("#srchVal").attr("placeholder",M.locale.localizedString("F1_10"));

	$("#srchVal").on("input", function() {
		var value = $(this).val();
		
		if (value == "") {
			$(".btn_cancel").addClass("none");
		}
		else {
			$(".btn_cancel").removeClass("none");
		}
	});
	
	$(".btn_cancel").on("touchend", function(e) {
		e.preventDefault();
		$("#srchVal").val("");
		$(".btn_cancel").addClass("none");
	});
	
	$("#close").click(Page.backPage);

	gvlInitScreenHeight=$(document).height();

	// google map Auto Complete 작동
	initAutoComplete()
});

function gfnItemProc() {
	$(gvlGetItemList).each(function(idx, item) {
		$(".result_none").addClass("none");
		$("#list").removeClass("none");
		if (MApi.param("testReq") != "" && item.DealerType == 2) {
			return true;
		}
		var temp = $("<li></li>").append(
			$("<button></button>").append(
				$("<h2></h2>").html(item.Name).addClass("ellipsis"))
				.append($("<p></p>").html(item.Street+", "+item.ZipCode+" "+item.Town))
				.append($("<p></p>").html((item.Distance/100*100).toFixed(2)+" km").addClass("txt_pos"))
		).click(function() {
			if(MApi.getPlatform()=="ANDROID"){
				var logics=gvlInitScreenHeight!=$(document).height();
				if(logics){
					WN2CommonAsync("exHideSoftKeyboard");
					var that=this;
					setTimeout(function(){
						var options=Options.Default;
						options.param={
							sapCode:$(that).data("sapCode"),
							marketId:$(that).data("marketId"),
							myLocCountry:MApi.param("myLocCountry"),
							testReq:MApi.param("testReq")
						};
						Page.moveToPage("mk_c02_0003",options);
					},700);
				}else{
					var options=Options.Default;
					options.param={
						sapCode:$(this).data("sapCode"),
						marketId:$(this).data("marketId"),
						myLocCountry:MApi.param("myLocCountry"),
						testReq:MApi.param("testReq")
					};
					Page.moveToPage("mk_c02_0003",options);
				}
			}else{
				var options=Options.Default;
				options.param={
					sapCode:$(this).data("sapCode"),
					marketId:$(this).data("marketId"),
					myLocCountry:MApi.param("myLocCountry"),
					testReq:MApi.param("testReq")
				};
				Page.moveToPage("mk_c02_0003",options);
			}
		}).data("sapCode", item.DealerSapCode).data("marketId", item.MarketId)
		.addClass("map_sub").appendTo($(".li_style_move"));
		
		temp.addClass("type0"+item.DealerType);		
	});
	
	if ($("#list > li").size() == 0) {
		$("#list").addClass("none");
		$(".result_none").removeClass("none");
	}
}

/**
 * Google map Auto Complete 구현
 */
function initAutoComplete() {
	var  element = document.getElementById('srchVal')
		,types = {types: ['geocode']}
		,customerId = LoginManager.getCustomerId()
		,autocomplete

	autocomplete = new google.maps.places.Autocomplete(element, types);
	autocomplete.addListener('place_changed', fillInAddress);

	// AutoComplete Callback
	function fillInAddress() {
		var place = autocomplete.getPlace();

		// Dealer Searching
		$('#list').html('');
		gvlGetItemNetwork.send({
			 CustomerId 	: customerId
			,Latitude 		: place.geometry.location.lat()
			,Longitude 		: place.geometry.location.lng()
			,LimitToMarket	: false
		});

		$('meta[name=viewport]').attr('content', 'width=device-width, height=device-height, initial-scale=1.0, user-scalable=no');
		$('meta[name=viewport]').attr('content', 'width=device-width, initial-scale=1.0, user-scalable=no');
	}
}
</script>
</html>
