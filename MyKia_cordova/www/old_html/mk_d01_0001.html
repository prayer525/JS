<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="format-detection" content="telephone=no, address=no, email=no">
<title>MyKia :: Dealer Locator :: list</title>
<link rel="stylesheet" type="text/css" href="../css/morpheus_style.css">
<script type="text/javascript" src="../js/mcore.min.js"></script>
<style type="text/css">
.gmnoprint {display: none !important}
a[target=_blank] {display: none !important}
#scroll {position:relative; overflow:hidden;}
.map_space {padding-top:0;}
.search {
	position: absolute;
	z-index: 100;
	left: 0;
	top: 0;
	width: 100%;
	height: 4.3rem;
	line-height: 4.3rem;
	border-top: 2px solid #bb162b;
	box-shadow: 0 .2rem .5rem gray;
	background: #fff;
}
.search.f_popup {
	background: #bb162b;
	border-bottom: 1px solid #770000;
}
.search.f_popup.type3 {
	position: absolute;
	top: 0rem;
	z-index: 1;
	padding:0.5rem 1rem;
}
.search.f_popup.type3 input {
	padding: 0 2.7rem 0 2.9rem !important;
    color: #fff;
    font-size: 1.4rem;
    background: transparent url('../img/ico_hsearch.png') no-repeat .5rem .5rem;
    background-size: 1.6rem;
    border: none;
    border-top: 1px solid #9b2c36;
}
.search.f_popup.type3 .btn_cancel{
	position: absolute;
    top: 0.5rem;
    right: 1rem;
    width: 2.9rem;
    height: 2.9rem;
    text-indent: -9999px;
    background: transparent url('../img/ico_hsearch_cancel.png') no-repeat center center;
    background-size: 1.4rem;
}
</style>
</head>
<body id="mk_c02_0001">
<!-- ========== Start ========== -->

<div id="wrapper">
	<header id="header">
        <h1><!-- Dealer Locator --><script type="text/javascript">M.locale.localizedWrite("F1_1")</script></h1>
		<button type="button" class="hbtn fl home">Home</button>
	</header>
	
	<!-- BTN_AREA_FIXED -->
	<div class="sub_head menu_fixed none">
		<p class="txt_tab">
            <strong id="cnt">0</strong> <!-- Dealers Found --><script type="text/javascript">M.locale.localizedWrite("E1_24")</script>
        </p>
	</div>

	<section id="container" class="h_sub_01">
		<div id="scroll">
        <!-- contents_Start -->     
        <!-- 검색 -->
		<div class="f_popup search type3">
			<p class="search_box">
				<input type="text" placeholder="" id="srchVal"/>
				<button type="button" class="btn_cancel none">delete</button>
			</p>
		</div>
            
			<!-- MAP_AREA -->
			<div class="map_space">
				<div class="map" id="map_canvas">
					<!-- 지도영역
					<button type="button" class="btn_now">now position</button>
					<button type="button" class="btn_zoom">zoom</button> -->
				</div>
				<!--type01 = sales / type02 = service / type03 = sales&service -->
				<!--전체 이동일 경우(Test Drive Request) -->
				<div class="map_sub type01 none" id="footType1">
					<button type="button" class="inside full">
						<h2 class="ellipsis">&nbsp;</h2>
						<p>&nbsp;</p>
						<p class="txt_pos">&nbsp;</p>
					</button>
				</div>
			</div>
                
        <!-- //contents_End -->        
		</div>
	</section>

	<footer id="footer">
		<p class="img">KIA, The Power to Surprise.</p>
	</footer>
</div>

<!-- ========== //End ========== -->
</body>
<script src="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js"></script>
<script type="text/javascript" src="../js/ui/common.js"></script>
<script type="text/javascript">
var myMarkerOptions={
	canvas:"map_canvas",
	markerIcon:""
},
place,
gvlGooglMapManager,
gvlGetItemList = null,
gvlGetItemListTemp = null,
gvlMyPosition = null,
gvlInitFlag=false,
gvlGetItemCallback={
	success:function(rev,setting){

		// API 2.16 통신 결과 성공 시 Marker를 맵에 표시한다. 리스트 갯수를 표시한다
		// GPS 리스트 결과
		MApi.log('rev : ' , rev);

		gvlGetItemList = rev.Dealers;
		gvlGetItemListTemp = rev.Dealers;
		gfnItemProc();
	}
},
gvlGetItemNetwork=new NetworkManager(TrCode.DealerLocationInformation,gvlGetItemCallback,false);

var gvlMarkerClickFlag=false;

// 딜러정보를 다시 받아온다.
var requestData = function(_position) {
	// 현재 위치 정보 수집 결과 성공 시 API 2.16 통신을 시작한다.
	if ($('#srchVal').val() !== '') {
		$(".btn_cancel").trigger('click');
	}
	gvlMyPosition = _position;
	gvlGooglMapManager.setCenter(parseFloat(gvlMyPosition.latitude), parseFloat(gvlMyPosition.longitude));
	gvlGetItemNetwork.send({
		CustomerId : LoginManager.getCustomerId(),
		Latitude : _position.latitude,
		Longitude : _position.longitude,
		Radius : 30000,
		LimitToMarket	: true
	});
}

M.onReady(function(e){
	$("#map_canvas").height(window.innerHeight - $("#map_canvas").offset().top - $("footer").height())
	
	gfnInit();
	
	$("#map_canvas").click(function() {
		if(gvlMarkerClickFlag==false) $("#footType1").addClass("none");
	});
	
	$("#srchVal").on("input", function() {
		var value = $(this).val();
		
		if (value == "") {
			$(".btn_cancel").addClass("none");
		}
		else {
			$(".btn_cancel").removeClass("none");
		}
	});

	$(".btn_cancel").on("click", function(e) {
		e.preventDefault();
		$("#srchVal").val("");
		place = null;
		$(".btn_cancel").addClass("none");
		gvlGetItemList = gvlGetItemListTemp;
		gfnItemProc();
	});
});

// 최초 진입 시 구글맵을 load 한다.
function gfnInit() {
	$('meta[name=viewport]').attr('content', 'width=device-width, height=device-height, initial-scale=1.0, user-scalable=no');
	$('meta[name=viewport]').attr('content', 'width=device-width, initial-scale=1.0, user-scalable=no');

	var ctn = 0;
	var loadInter = setInterval(function(){
		if(gvlGoogleMapLoad){
			clearInterval(loadInter);
			// gvlGooglMapManager.callGeolocation();
		}else if(ctn > 40){
			clearInterval(loadInter);
			// MApi.alert(M.locale.localizedString("F1_32"), Page.backPage);
		}
		ctn++;
	},100)
	
	gvlGooglMapManager=new GoogleMapManager(myMarkerOptions,{
		load:function(_status){
			if(_status=="FAILE"){
				MApi.alert(M.locale.localizedString("F1_32"), Page.backPage);
			}
		},
		geo:function(_status,_position){
			setTimeout(function(){
				if(_status=="SUCCESS"){
					if (M.locale.VirtualMode) {
						_position = {
							 latitude: "48.9800315"
							,longitude: "2.5164418"
						}
					}
					if(gvlGpsNok){
						gvlGpsNok = false;
						gvlGooglMapManager.userLocation(function(location){
							// 구글맵 Load 결과 성공 시 현재 위치 정보를 수집한다
							requestData(location);
						});
					}else{
						// 구글맵 Load 결과 성공 시 현재 위치 정보를 수집한다
						requestData(_position);
					}
				
				}else{
					
					// 실패 시 알림 팝업을 호출하고 “확인”버튼 터치 시 이전 화면으로 이동한다
					gvlInitFlag=true;
					MApi.confirm(M.locale.localizedString("V1_10"),[M.locale.localizedString("D1_9"), M.locale.localizedString("S1_21")],gvlGooglMapManager.goSetting);
				}

				// google map Auto Complete 작동
				initAutoComplete()
			},100)
		},
		scale:function(){
			if ($("header").hasClass("none")) {
				$("header").removeClass("none");
				$(".sub_head").removeClass("none");
				$("#container").removeClass('top0')
				$("#map_canvas").height($("#map_canvas").height() - $(".sub_head").outerHeight() - $("header").outerHeight());
			}
			else {
				$("header").addClass("none");
				$(".sub_head").addClass("none");
				$("#container").addClass('top0')
				$("#map_canvas").height($("#map_canvas").height() + $(".sub_head").outerHeight() + $("header").outerHeight());
			}
		},
		optIns:function(_idx){
			//gvlInitFlag=true;
			//gvlGooglMapManager.setGps(_idx, gfnInit);
			if (_idx==1) { // Gps setting logic is Make
				var optInsVal = MApi.storage(Storage.optInsVal);
				if (!optInsVal) {
					var optInsVal = {
				        gps:true,
				        call:false
				    }
				}else{
					optInsVal.gps = true;
				}
				
			    MApi.storage(Storage.optInsVal, optInsVal);
			}
			else { // User address logic is Make
				gvlGpsNok = true;
		    }
			gfnInit();
		},
		setting:function(_idx){
			gvlInitFlag=true;
			gvlGooglMapManager.goSetting(_idx);
		}
		,confirm:function(){
			var msg = M.locale.localizedString("V1_12") ,
				options={
						title : M.locale.localizedString("V1_11"),
						buttons : [M.locale.localizedString("V1_13"), M.locale.localizedString("V1_14")]
				},
				callback = function(_idx){
					if (_idx==1) { // Gps setting logic is Make
						var optInsVal = MApi.storage(Storage.optInsVal);
						if (!optInsVal) {
							var optInsVal = {
						        gps:true,
						        call:false
						    }
						}else{
							optInsVal.gps = true;
						}
						
					    MApi.storage(Storage.optInsVal, optInsVal);
					}
					else { // User address logic is Make
						gvlGpsNok = true;
				    }
					gfnInit();
				};
			if(MApi.getPlatform()=="iOS"){
				options.waitUntilDone=false;
				M.pop.alert(msg,options,callback);
			}else{
				exWNAlertPopup(msg,options,callback);
			}
		}
	});
}

// API 2.16 통신 결과 성공 시 Marker를 맵에 표시한다. 리스트 갯수를 표시한다
function gfnItemProc() {
	$('.li_style_move').html('');
	gvlGooglMapManager.clearMarker();

	$(gvlGetItemList).each(function(idx, item) {
		
		var itemMarkOpt = {
			markerIcon : "../img/imap_maker.png",
			listener : function(e) {
				gvlGooglMapManager.changeMarkerImg(idx);
				
				// Marker 터치 시 딜러 정보를 표시한다
				gvlMarkerClickFlag=true;
				$("#footType1").removeClass("none");
				$("#footType1").find("h2").html(item.Name);
				$("#footType1").find("p").eq(0).html(item.Address);
				$("#footType1").attr("class", $("#footType1").attr("class").replace(/type0[1-3]/g, "type0"+item.Type))
				/*
				$("#footType1").find("p").eq(0).html(item.Street+", "+item.ZipCode+" "+item.Town);
				$("#footType1").find("p").eq(1).html((item.Distance/100*100).toFixed(2)+" km");
				$("#footType1").attr("class", $("#footType1").attr("class").replace(/type0[1-3]/g, "type0"+item.DealerType));
				
				$("#footType1").off("click");
				*/
				// 딜러 정보 터치 시 딜러 상세 화면(mk_c02_0003)으로 이동한다

				$("#footType1").data("sapCode", item.DealerSapCode);
				
				$("#footType1").click(function() {
					var options=Options.Default;
						options.param={
							sapCode:$(this).data("sapCode")
						};
					Page.moveToPage("mk_c02_0003",options);
				});
				setTimeout(function(){
					gvlMarkerClickFlag=false;
				},500);
				
			}
		},
		that = {
			coords : {
				latitude : item.Latitude,
				longitude : item.Longitude,
			}
		}
		gvlGooglMapManager.addChildMarker(that, itemMarkOpt);
	});

	gvlGooglMapManager.clusterMap();

	gvlGooglMapManager.setCenter(parseFloat(gvlMyPosition.latitude), parseFloat(gvlMyPosition.longitude));

	if($(".li_style_move > li").size()==0){
		$('.result_none_dealer').show();
	}else{
		$('.result_none_dealer').hide();
	}
}

/**
 * Google map Auto Complete 구현
 */
function initAutoComplete() {
	var  element = document.getElementById('srchVal')
		,countryCode = LoginManager.getDetailsInfo().CountryCode.toLowerCase()
		,types = {types: ['geocode'],componentRestrictions: {country: countryCode}}
		,customerId = LoginManager.getCustomerId()
		,autocomplete

	autocomplete = new google.maps.places.Autocomplete(element, types);
	autocomplete.addListener('place_changed', fillInAddress);

	// AutoComplete Callback
	function fillInAddress() {
		if (M.locale.VirtualMode) {
			return false;
		}
		place = autocomplete.getPlace();

		// Dealer Searching
		$('#list').html('');
		gvlGetItemNetwork.send({
			 CustomerId 	: customerId
			,Latitude 		: place.geometry.location.lat()
			,Longitude 		: place.geometry.location.lng()
			,Radius			: 30000
			,LimitToMarket	: true
		});
		gvlMyPosition.latitude = place.geometry.location.lat();
		gvlMyPosition.longitude = place.geometry.location.lng();

		$('meta[name=viewport]').attr('content', 'width=device-width, height=device-height, initial-scale=1.0, user-scalable=no');
		$('meta[name=viewport]').attr('content', 'width=device-width, initial-scale=1.0, user-scalable=no');
	}
}

M.onResume(function(e) {
	if(gvlInitFlag){
		gvlInitFlag=false;
		gfnInit();
	}
});

M.onRestore(function(e) {
	if(gvlInitFlag){
		gvlInitFlag=false;
		gfnInit();
	}
});
</script>
</html>