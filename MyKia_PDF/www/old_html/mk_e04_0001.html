<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="format-detection" content="telephone=no, address=no, email=no">
<title>MyKia :: My Kia News :: list</title>
<link rel="stylesheet" type="text/css" href="../bower_components/bootstrap/dist/css/bootstrap.min.css">
<link rel="stylesheet" type="text/css" href="../css/morpheus_style.css">
<link rel="stylesheet" href="../bower_components/swiper/dist/css/swiper.min.css">
<script type="text/javascript" src="../js/mcore.min.js"></script>
<script type="text/javascript" src='../js/libs/slide/jquery.touchSlider.js'></script>
<style type="text/css">
.paging_btn{
	display:block;
	border-radius: 1.8rem;
	width:auto;
    height: 3.6rem;
    line-height: 3.6rem;
    background: #bb162b;
    color: #fff;
    font-size: 1.6rem;
    font-weight:bold;
    letter-spacing:0.5px;
    padding: 0rem 2.5rem;
    margin:1rem auto 0;
}

#mk_e04_0001 .container {padding-top:4.3rem;}
#mk_e04_0001 .container h2 {height:4.2rem; line-height:4.2rem; color:#666; font-size:1.6rem; padding:1rem 1rem 0;}
#mk_e04_0001 .container #list {margin-top:0;}

.result_none_campaign{width:100%;height:100%;}
.result_none_campaign p{padding-top:3.5rem;text-align:center !important;font-size:1.4rem;font-weight:bold;color:#A9A9A9 !important;}

.swiper-container {
    height: 12.5rem;
    padding-bottom:2rem;
    margin:0 1rem;
}
.swiper-slide {
	text-align: center;
    font-size: 18px;
    background: transparent;
    
    /* Center slide text vertically */
    display: -webkit-box;
    display: -ms-flexbox;
    display: -webkit-flex;
    display: flex;
    -webkit-box-pack: center;
    -ms-flex-pack: center;
    -webkit-justify-content: center;
    justify-content: center;
    -webkit-box-align: center;
    -ms-flex-align: center;
    -webkit-align-items: center;
    align-items: center;
    width:30%;
    margin-right:10px;
}
.swiper-slide button {display:block; width:100%; height:100%; background:transparent;}
.swiper-slide button img {display:block; width:100%; height:7.5rem;}
.swiper-slide button p {height:3rem; line-height:1.5rem; font-size:1.1rem; overflow:hidden; text-align:left;}
.swiper-pagination {bottom:0 !important;}
.swiper-pagination .swiper-pagination-bullet-active {background:#bb162b;}

.btn-see-all {position:absolute; top:1.5rem; right:1rem; height:2.7rem; line-height:2.7rem; color:#bb162b; border:none; background:none; padding:0 0.5rem;}
.btn-see-all img {display:block; width:20px; height:20px; vertical-align:middle;}
</style>
</head>
<body id="mk_e04_0001">
<!-- ========== Start ========== -->

<div id="wrapper">
    <header id="header">
        <h1><!-- My Kia News --><script type="text/javascript">M.locale.localizedWrite("G1_1")</script></h1>
        <button type="button" class="hbtn fl home">Home</button>
    </header>

	<section id="container" class="container">
		<div id="scroll">
			<h2><script type="text/javascript">M.locale.localizedWrite("B1_27")</script></h2>
			<div class="row news_list">
				<ul id="list">
					<!--li>
						<a href="mk_e01_0002.html">
							<div class="thum"><img src="https://www.kia.com:443/se/-/media/se/mykia/news/nya-sportage-sweden.ashx?mw=800&mh=800" alt=""></div>
							<p>I Re della Corea</p>
							<i>Technology <span>13 Jun 2016</span></i>
						</a>
					</li-->
				</ul>
			</div>
			<button class="paging_btn"><script type="text/javascript">M.locale.localizedWrite("D1_20")</script></button>
			<!-- No Search Result -->
            <div class="result_none none">
                <p><script type="text/javascript">M.locale.localizedWrite("D1_16")</script></p>
            </div>
            <div style="position:relative;">
            	<button type="button" class="btn-see-all"><img src="../img/icon_more.png" alt=""></button>
	            <h2 class="tit-campaign"></h2>
	            <div id="touchSlider" class="swiper-container">
					<div class="swiper-wrapper">
						
					</div>
					<div class="swiper-pagination"></div>
				</div>
			</div>
		</div>
	</section>

	<footer id="footer">
		<p class="img">KIA, The Power to Surprise.</p>
	</footer>
</div>

<!-- ========== //End ========== -->
</body>
<script type="text/javascript" src="../bower_components/moment/min/moment-with-locales.min.js"></script>
<script type="text/javascript" src="../js/ui/common.js"></script>
<script type="text/javascript" src="../bower_components/swiper/dist/js/swiper.min.js"></script>
<script type="text/javascript">
var initialPage = 0,
	offset = 0,
	pageSize = 4
var gvlNewsCallback = {
	success:function(rev,setting){
		var  news = sortList(rev.News)
			,campaigns = sortList(rev.Campaigns)
			,str = ''
			,newsDate
			,hasRead
			,promotionCnt = 0
			,unReadCnt = 0;

		// Api변경후에는 PaginatedNews 로 변경
		for (var i in news) {
			newsDate = JsUtil.MomentDateFormat(news[i].NewsDate, 'LL');

			if (newsDate == 'Invalid date') {
				newsDate = '';
			}
			
			hasRead = '';
			if (news[i].NewsRead == true) {
				hasRead = 'has-read';
			}

			str += '<li data-news="' + news[i].NewsId + '" data-category="'+ news[i].NewsCategory+'" class="' + hasRead + '">';
			str += '	<a href="#">';

			if (M.locale.VirtualMode) {
				str += '		<div class="thum" style="background-image:url(' + "data:"+news[i].NewsImageExtension+";base64,"+news[i].NewsImage + ')"></div>';
			} else {
				str += '		<div class="thum" style="background-image:url(' + news[i].NewsImageUrl + ')"></div>';
			}

			//str += '		<div class="thum" style="background-image:url(' + news[i].NewsImageUrl + '?mw=200)"></div>';
			str += '		<p>' + news[i].NewsTitle + '</p>';
			str += '		<i><span>' + getMagazineCategoryString( news[i].MagazineCategory ) + '</span><br />' + newsDate + '</i>';
			str += '	</a>';
			str += '</li>';
		}

		$('#list').append(str);
		// paging
		if(rev.NewsRecordsFiltered > 0 && 
				(rev.NewsRecordsFiltered - (offset * pageSize)) > 0){
			$(".paging_btn").show();
		}else{
			$(".paging_btn").hide();
		}
		
		$('[data-news]').on('click', function(){
			var  $this = $(this)
				,options=Options.Default
				,newsid = $this.data('news')

			// 각 리스트 터치 시 해당 내용에 맞는 유튜브 링크로 연결이 된다.
			if (!$this.hasClass("has-read")) {

				// 이전에 읽지 않은 리스트 인 경우 API 2.22 통신을 시작한다
				new NetworkManager(TrCode.NewsRead, {success:function(rev,setting){

					// API 2.22 통신 성공 시 읽지 않은 비디오 카운트를 갱신한다.

					var loginInfo = LoginManager.getLoginInfo();
					loginInfo.Notification.MyKiaNewsCnt--;
					LoginManager.setLoginInfo(loginInfo);

					$this.addClass('has-read');
					options.param = {
						 'newsId' : newsid
					};
					Page.moveToPage('mk_e01_0002', options);
				}, error:function(code,msg,setting) {
					void(0);
				}}, false, {show:false}).send({
					CustomerId : LoginManager.getCustomerId(),
					NewsCategory : 0,
					NewsId : newsid
				});
			}else{
				options.param = {
					 'newsId' : newsid
				};
				Page.moveToPage('mk_e01_0002', options);
			}
		})
		
		// 현재페이지가 처음일때만 캠페인 목록 생성
		if(initialPage == 0){
			for (var i in campaigns) {
				newsDate = JsUtil.MomentDateFormat(campaigns[i].NewsDate, 'LL');

				if (newsDate == 'Invalid date') {
					newsDate = '';
				}
				
				var temp = $("<div class='swiper-slide'></div>").append(
					$("<button></button>").append(
						$("<img />").attr("src", campaigns[i].NewsImageUrl)
					).append(
						$("<p></p>").html(campaigns[i].NewsTitle)
					)
				).click(function() {
					// 리스트 터치 시 상세 화면(mk_e01_0002)으로 이동한다
					var options=Options.Default,
						target = $(this);
						options.param={
							newsId:target.data("newsId"),
							pageTitle:'mk_e01_0001'
						};
						
					// API 2.22 통신을 시작한다. 
					if (!target.data("isRead")) {
						new NetworkManager(TrCode.NewsRead, {success:function(rev,setting){
							
							// API 2.22 통신 결과 성공 시 홈에 표시하는 Sales&Promotions 뱃지 카운트를 감소 시킨다.
							target.data("isRead", true);
							var loginInfo = LoginManager.getLoginInfo();
							loginInfo.Notification.SalesNProCnt--;
							LoginManager.setLoginInfo(loginInfo);

							Page.moveToPage("mk_e02_0002",options);
						}, error:function(code,msg,setting) {
							void(0);
						}}, false, {show:false}).send({
							CustomerId : LoginManager.getCustomerId(),
							NewsCategory : campaigns[i].NewsCategory,
							NewsId : target.data("newsId")
						});
					}else{
						Page.moveToPage("mk_e02_0002",options);
					}
				}).data("newsId", campaigns[i].NewsId).data("isRead", campaigns[i].NewsRead);
				
				if (!campaigns[i].NewsRead) {
					unReadCnt++;
				} else {
					//temp.find("button").addClass("read");
				}
				temp.appendTo($(".swiper-wrapper"));
			}
			
			if ($(".swiper-wrapper > div").size() == 0) {
				var noResult = '<div class="result_none_campaign"><p>'+M.locale.localizedString("D1_18")+'</p></div>'
				$(".swiper-wrapper").html(noResult);
				$(".btn-see-all").hide();
			}else{
				// 프로모션이 2개 이상일때만 swipe
				var slideCounter = 3
				if($(window).innerWidth() > 500) {
					slideCounter = 4
				}else if($(window).innerWidth() > 600) {
					slideCounter = 5
				}

				if(campaigns.length > 2){
					var swiper = new Swiper('.swiper-container', {
				        pagination: '.swiper-pagination',
				        slidesPerView: slideCounter,
				        paginationClickable: true,
				        spaceBetween: 10
				    });
				}
			}

			var loginInfo = LoginManager.getLoginInfo();
			loginInfo.Notification.SalesNProCnt = unReadCnt;
			LoginManager.setLoginInfo(loginInfo);
		}
		
	}
}

$(".paging_btn").click(function(){
	initialPage++;
	offset++;
	getNewsList();
});

$(".btn-see-all").click(function(){
	Page.moveToPage('mk_e02_0001')
})

//gvlNewsNetwork = new NetworkManager('HTTPS_RHM', TrCode.NewsList, gvlNewsCallback, true);
gvlNewsNetwork = new NetworkManager(TrCode.NewsListV2, gvlNewsCallback, true);

// 최초 진입 시 API 2.18 통신을 시작한다.
M.onReady(function(e){
	getNewsList();
	$('.tit-campaign').text(M.locale.localizedText("B1_40"))
});

function getNewsList(){
	gvlNewsNetwork.send({
		CustomerId : LoginManager.getCustomerId(),
		InitialPage : initialPage,
		Offset : offset,
		PageSize: pageSize
	});
}

// news 날짜순 정렬
function sortList(list) {
	list.sort(function(a, b) {
		if (a.NewsDate > b.NewsDate) {
			return -1;
		}
		return 1;
	})
	return list;
}

</script>
</html>

