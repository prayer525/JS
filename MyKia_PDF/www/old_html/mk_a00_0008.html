<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="format-detection" content="telephone=no, address=no, email=no">
<title>MyKia :: Language</title>
<link rel="stylesheet" type="text/css" href="../css/morpheus_style.css">
<script type="text/javascript" src="../js/mcore.min.js"></script>
</head>
<body id="mk_a00_0008">
<!-- ========== Start ========== -->

<div id="wrapper">
	<header id="header" class="f_popup">
		<h1><!-- Language --><script type="text/javascript">M.locale.localizedWrite("B1_23");</script></h1>
		<button type="button" class="hbtn fl back_white" id="close">Back</button>
		<button type="button" class="hbtn fr" id="save"><!-- Save -->
			<script type="text/javascript">M.locale.localizedWrite("B1_3");</script>
		</button>
	</header>

	<section id="container">
		<div id="scroll">
		<!-- contents_Start -->
			<ul id="list">
			</ul>
		<!-- //contents_End -->
		</div>
	</section>

	<footer id="footer">
		<p class="img">KIA, The Power to Surprise.</p>
	</footer>
</div>

<!-- ========== //End ========== -->
</body>
<script type="text/javascript" src="../js/ui/common.js"></script>
<script type="text/javascript">
var gvlWasLang=M.locale.get(),
	gvlVersionVal=[],
	gvlSelCultureCodeVer=0,
	gvlVersionCallback = {
		success : function(rev, setting) {
			
			// receive latest language translation code if there has new version for selected language with API 2.28
			// 선택한 언어의 현재 버전보다 상위 버전이 있을 경우
			// 해당 언어에 대한 번역 정보를 수신하기 위해 API 2.28을 호출
			gvlVersionVal = rev.TranslationVersions;
			gfnSend(gvlWasLang);
		},
		error : function(code, msg) {

			// no action
			// 아무 동작 없음.
			void(0);
		},
		networkConnectFail:function(){
			Page.backPageModalDown();
		}
	},
	gvlVersion=new NetworkManager(TrCode.ContentVersion, gvlVersionCallback, true);

M.onReady(function(e){
	// call API 2.30 for latest language version information
	// 언어 버전 정보를 수신하기 위해 API 2.30을 호출
	gvlVersion.send({empty:"empty"});
});

// display selected language when landing this screen
// 최초 진입 시 기존 선택된 언어를 표시한다.
gfnInitList();
function gfnInitList(){
	var supportList=[];
	var marketId = LoginManager.getDetailsInfo().MarketId;
	var langGroup = {
		"KMSW":[{
			title:"Svenska-Sverige",
			culturecode:"sv-SE",
			open:true
		}],
		"KMIT":[{
			title:"Italiano-Italia",
			culturecode:"it-IT",
			open:true
		}],
		"KMBE":[{
			title:"Français-Belgique",
			culturecode:"fr-BE",
			open:true
		},{
			title:"Nederlands-België",
			culturecode:"nl-BE",
			open:true
		}],
		"KMCZ":[{
			title:"Čeština-Česká Republika",
			culturecode:"cs-CZ",
			open:true
		}],
		"KMAT":[{
			title:"Deutsch-Österreich",
			culturecode:"de-AT",
			open:true
		}],
		"KMDE":[{
			title:"Deutsch-Deutschland",
			culturecode:"de-DE",
			open:false
		}],
		"KMES":[{
			title:"Español-España",
			culturecode:"es-ES",
			open:true
		}],
		"KMFR":[{
			title:"Français-France",
			culturecode:"fr-FR",
			open:true
		}],
		"KMIT":[{
			title:"Italiano-Italia",
			culturecode:"it-IT",
			open:true
		}],
		"KMHU":[{
			title:"Magyar-Magyarország",
			culturecode:"hu-HU",
			open:true
		}],
		"KMPL":[{
			title:"Polski-Polska",
			culturecode:"pl-PL",
			open:true
		}],
		"KMSK":[{
			title:"Slovenčina-Slovensko",
			culturecode:"sk-SK",
			open:true
		}],
		"KMSE":[{
			title:"Svenska-Sverige",
			culturecode:"sv-SE",
			open:true
		}]
	}

	// POC 모드에서는 영어와 프랑스어만 사용함 (1.4 fr 버전 기준)
	if (M.locale.PocMode) {
		supportList.push(
			{
				title:"English",
				culturecode:"en-US",
				open:true
			}
		);
		supportList.push(
			{
				title:"Français-France",
				culturecode:"fr-FR",
				open:true
			}
		);
		
	} else {
		supportList.push(
			{
				title:"English",
				culturecode:"en-IE",
				open:true
			}
		);

		$.each(langGroup[marketId], function(i, v){
			supportList.push(
				{
					title:v.title,
					culturecode:v.culturecode,
					open:v.open
				}
			);
		})
	}

	// display languages list
	// 언어를 화면에 표시한다.
	[].forEach.call(supportList,function(item,idx){
		if(item.open&&M.locale.DevMode==false){
			create();
		}else if(M.locale.DevMode){
			create();
		}
		function create(){
			var li=$("<li></li>").addClass("hbox jc"),
			label=$("<label for='rd"+idx+"' class='flex'>"+item.title+"</label>"),
			input=$("<input type='radio' name='rd01' data-culturecode='"+item.culturecode+"' id='rd"+idx+"'/>");
			li.append(label).append(input);
			$("#list").append(li);
		}
	});

	$("#list input").each(function(i,item){
		if(gvlWasLang==$(item).data("culturecode")){
			$(item).attr("checked",true);
		}
		$(item).click(onItemClickListener);
		function onItemClickListener(){
			// receive latest language transtion code using API 2.28 when language is selected
			// 언어 선택 시 해당 언어에 대한 번역 정보를 수신하기 위해 API 2.28을 호출
			var locale=M.locale.get(),
				culturecode=$(this).data("culturecode");
			if(locale!=culturecode) gfnSend(culturecode);
		}
	});
}

// receive latest language transtion code using API 2.28 when language is selected
// 언어 선택 시 해당 언어에 대한 번역 정보를 수신하기 위해 API 2.28을 호출
function gfnSend(culturecode){
	var callback={
		success:function(rev,setting){
			
			// save latest selected language trasition information to the storage
			// API 2.28 통신 결과 성공 시 해당 언어에 대한 번역 정보를 스토리지에 저장한다
			// if(culturecode=="en-US") M.locale.set(culturecode);
			// else if(rev.Translations.length!=0) gfnGenerater(rev,culturecode);
			if(rev.Translations.length!=0) gfnGenerater(rev,culturecode);
		},
		error:function(code,msg){

			// recovery existing language when network failed
			// 실패 시 기존에 저장되어 있던 언어로 원복 한다
			$("#list input").each(function(i,item){
				if(gvlWasLang==$(item).data("culturecode")){
					$(item).click();
				}
			});
		},
		networkConnectFail:function(){
			$("#list input").each(function(i,item){
				if(gvlWasLang==$(item).data("culturecode")){
					$(item).click();
				}
			});
		}
	};
	var versionCheck = false;
	$(gvlVersionVal).each(function(i, item) {
		if (culturecode == item.CultureCode) {
			// if (culturecode == "en-US" && item.Version == 1) {
			// 	versionCheck = true;
			// 	return false;
			// }
			var culturecodeversion = MApi.storage(culturecode+"-ver");
			if (culturecodeversion == item.Version) {
				versionCheck = true;
				return false;
			}
			else {
				gvlSelCultureCodeVer = item.Version;
				return false;
			}
		}
	});
	if (versionCheck) {
		M.locale.set(culturecode);
		return;
	}
	new NetworkManager(TrCode.TranslationList,callback,false).send({"CultureCode":culturecode});
}

// save language information to the storage
// 언어를 로컬에 저장한다.
function gfnGenerater(data,culturecode){
	var gen={};
	[].forEach.call(data.Translations,function(item){
		for(var i in item){
			gen[i]=item[i];
		}
	});
	MApi.storage(culturecode,gen);
	MApi.storage(culturecode+"-ver", gvlSelCultureCodeVer);
	M.locale.set(culturecode);
}

// touch back button
// go back with recovery existing language if user does not save
// 이전버튼을 터치한다.
// 언어 설정 취소 시
// 기존에 적용되어 있던 언어로 원복하고 이전화면으로 돌아간다.
$("#close").click(gfnCloseLang);
function gfnCloseLang() {
	Page.backPageModalDown();
	M.locale.set(gvlWasLang);
}

// move to main screen with save language information user saved it
// and call API 2.28 with background
// 언어 설정 저장 시
// 해당 언어 설정을 저장하고 메인화면으로 돌아간다. 
// putLanguage 메인화면으로 돌아가면서 API 2.28 통신을 백그라운드로 호출한다.
function gfnSaveLan() {
    
    MApi.clearAllStack();
    
	M.data.global("putLanguage","YES");
	var options=Options.Default,
		locale=M.locale.get();
	options.animation = "FADE";
	Page.moveToPage("mk_a00_0005",options);
}
$("#save").click(gfnSaveLan);
M.onBack=gfnCloseLang;
</script>
</html>